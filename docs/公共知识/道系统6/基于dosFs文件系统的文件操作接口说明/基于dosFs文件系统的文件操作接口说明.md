<div align='center'><font size=8>基于dosFs文件系统的文件操作接口说明</font></div>

## 1. 时间

2023 年 12 月 20 日

## 2. 简介

文件系统（file system）是命名文件及放置文件的逻辑存储和恢复的系统。在操作系统中文件被放置在分等级的（树状）结构中的某一处。文件被放置进目录或子目录，在树状结构中你希望的位置中。
文件系统是软件系统的一部分，它的存在使得应用可以方便的使用抽象命名的数据对象和大小可变的空间。
dosFs文件系统是一个与ms-dos兼容的文件系统，它提供了相当大的灵活性，适合于实时应用程序的多种需求，支持FAT12、FAT16、FAT32文件分配表类型。

## 3. 功能

文件的系统是操作系统用于明确磁盘或分区上的文件的方法和数据结构；即在磁盘上组织文件的方法。也指用于存储文件的磁盘或分区，或文件系统种类。
磁盘或分区和它所包括的文件系统的不同是很重要的。少数程序（包括最有理由的产生文件系统的程序）直接对磁盘或分区的原始扇区进行操作；这可能破坏一个存在的文件系统。大部分程序基于文件系统进行操作，在不同种文件系统上不能工作。
文件系统的功能包括：管理和调度文件的存储空间，提供文件的逻辑结构、物理结构和存储方法;实现文件从标识到实际地址的映射，实现文件的控制操作和存取操作，实现文件信息的共享并提供可靠的文件保密和保护措施，提供文件的安全措施。

## 4. 文件操作接口概述

### 4.1 fopen接口

fopen的函数原型为： FILE *fopen(const char *filename, const char *mode);其功能是使用给定的模式 mode 打开 filename 所指向的文件。文件顺利打开后，指向该流的文件指针就会被返回。如果文件打开失败则返回 NULL，并把错误代码存在 error 中。

#### 4.1.1 fopen流程

![图片演示](.\pic\fopen.png)

fopen首先从堆中为文件流指针申请一片可用的内存，然后再调用open函数对文件进行操作，并把open返回的文件描述符存储到文件流指针中，再根据模式参数进行文件指针的偏移，最后返回指向文件的文件流指针。

### 4.2 open接口

open是打开和创建文件的函数，原型为open(const char *pathname,int flags，mode_t mode)。
对于open函数来说，第三个参数仅当创建新文件时（即 使用了O_CREAT 时）才使用，用于指定文件的访问权限位（access permission bits）。pathname 是待打开/创建文件的POSIX路径名（如/home/user/a.cpp）；flags 用于指定文件的打开/创建模式。

#### 4.2.1 open流程

![图片演示](.\pic\open.png)

在dosFs文件系统中，open函数利用dosFs文件系统提供的文件打开接口根据参数创建或者打开已有的文件，并未返回一个标识文件的文件描述符。

### 4.3 write接口

在嵌入式实时操作系统中，write函数是一个重要的系统调用函数，用于将数据从缓冲区写入文件或者套接字；fwrite、fflush函数也是通过调用write实现功能的。
write函数原型为ssize_t write(int fd, const void *buf, size_t nbyte)；其参数表示分别为fd：文件描述符；buf：指定的缓冲区，即指针，指向一段内存单元；nbyte：要写入文件指定的字节数；其作用是把buf中nbyte字节的数据写入文件描述符所指的文档，成功时返回写的字节数，错误时返回-1。

#### 4.3.1 write流程

![图片演示](.\pic\write.png)

在dosFs文件系统中，write实际是调用了dosFs的写数据函数把数据传递给XBD，XBD驱动的数据操作接口根据文件描述符找到对应的高速缓存地址，将数据放入其中，然后在发送一个命令到AHCI驱动器（ahciCommand），AHCI接收到指令后在硬盘空闲时操作CACHE将数据写入到磁盘中。
AHCI英文全称：Serial ATA Advanced Host Controller Interface（串行ATA高级主控接口/高级主机控制器接口），是一种硬盘接口标准，它允许存储驱动程序启用高级串行 ATA 功能，旨在提升硬盘的读写效率。
AHCI本质是一种PCI类设备，在系统内存总线和串行CPU设备内部逻辑之间扮演一种通用接口的角色。这个类设备描述了一个含控制和状态区域、命令序列入口表的通用系统内存结构；每个命令表入口包含SSD设备编程信息，和一个指向（用于在设备和主机传输数据的）描述表的指针。
CACHE是进行高速数据交换的存储器，它先于内存与CPU交换数据；工作原理是当CPU要读取一个数据时，首先从CPU缓存中查找，找到就立即读取并送给CPU处理；没有找到，就从速率相对较慢的内存中读取并送给CPU处理，同时把这个数据所在的数据块调入缓存中，可以使得以后对整块数据的读取都从缓存中进行，不必再调用内存。在CPU与磁盘之间，CACHE是必不可少的，它起到了预读取，写入，临时储存的作用；磁盘的存储量大，但是速度低，不能匹配上高速的CPU,因此需要一个过渡桥梁连接两端，CACHE就是这座桥梁。

### 4.4 read接口

read函数原型为ssize_t read(int fd, void *buf, size_t count)；参数count是请求读取的字节数，读上来的数据保存在缓冲区buf中，同时文件的当前读写位置向后移；fread通过调用read接口实现文件的读取功能。

#### 4.4.1 read流程

![图片演示](.\pic\read.png)

在dosFs文件系统中，从文件中读取数据是利用文件系统提供的读数据接口dosFsRead利用AHCI进行cache操作提升效率。通过文件描述符，系统找到对应逻辑地址，然后将逻辑地址传递给磁盘，磁盘的控制电路按照寻址逻辑将逻辑地址翻译成物理地址，找到对应的扇区将数据取出放到高速缓存中，当AHCI控制器接收到读数据指令后将高速缓存中的数据取出。

### 4.5 fprintf 接口

fprintf是C/C++中的一个格式化库函数，其作用是格式化输出到一个流文件中；函数原型为int fprintf( FILE *stream, const char *format, [ argument ]...)，fprintf会根据参数format 字符串来转换并格式化数据，然后将结果输出到参数stream 指定的文件中，直到出现字符串结束('\0')为止。

#### 4.5.1 fprintf 流程

![图片演示](.\pic\fprintf.png)

fprintf向打开的文件流中输入数据，其首先是将数据按照指定的格式排列，然后再将排列好的字符串一个字符一个字符的传输到文件流开辟的缓冲区中保存，等待后续的处理。

### 4.6 fflush接口

fflush是一个在C语言标准输入输出库中的函数，原型为int fflush(FILE *stream)，其功能是将缓冲区内的数据写回参数stream 指定的文件中。如果成功刷新,fflush返回0。指定的流没有缓冲区或者只读打开时也返回0值。返回EOF指出一个错误。

#### 4.6.1 fflush流程

![图片演示](.\dosFs\fflush.png)

fflush将文件流里所存储的文件描述符和存储数据的缓冲区地址解析出来，并将这些传递给write函数，最后利用磁盘的写操作将缓冲区中存储的数据刻录到扇区中。