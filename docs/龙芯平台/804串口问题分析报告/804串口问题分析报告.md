<div align='center'><font size=8>804 串口问题分析报告</font></div>

## 1.时间

2023 年 5 月 9 日

## 2.项目

804 所龙芯 XXX 项目

## 3.应用场景

在龙芯3A3000硬件板卡上，使用PCIE的时统卡设备以16Hz的频率产生中断，同时使用3A上的串口0进行大量数据的接收（一帧数据27字节）。

## 4.问题现象

设置3A上串口0以 波特率115200 ，8数据位，1停止位，奇效验模式进行数据接收，外部串口发送节点以一帧27个字节的数据进行发送，在不开启时统卡设备中断时，串口接收正常，没有数据丢失和错乱；当时统卡设备开启中断，以16Hz频率产生中断并正常进入中断服务程序进行中断处理时，此时串口进行接收会出现数据丢失和错乱。 


## 5.解决方案

### 5.1 排查思路

1. 是否为TY层导致数据丢失；
2. 串口驱动层是否就没有完整的处理到数据；
3. 时统卡中断服务程序处理时间太长。

### 5.2 排查过程

1. 在串口驱动的中断接收处理函数中获取数据，发现数据在这里已经丢失，排除了TY层丢失数据的怀疑；多次测试发现单次最多可以处理16字节的数据，此时怀疑是否为串口处理数据不够快导致串口的接收缓冲区溢出导致数据丢失。
2. 排查是否为接收处理函数不快导致数据溢出：此时把接收中断触发设置为一个字节触发一次，在串口中断处理函数中和系统中断派发出分别进行计数测试，测试发现两处中断次数一致，但是中断的次数对不上发送的数据个数。
3. 进一步排查串口驱动，核对寄存器的设置，驱动没有问题，此时就向中断数不对方向排查：中断次数不对情况分两种，一是硬件上就没产生中断；二是硬件产生了中断，但是在处理其它中断导致串口中断丢弃了。
4. 追查发现硬件产生了中断，是系统把中断给丢弃了，结合问题现象分析，可能还是在时统卡中断处理上出了问题。
5. 采用时间戳测试时统卡中断处理时间，测试结果显示时统卡中断处理时间达到了大约15.2ms；分析驱动代码发现是有很大的延时处理，并且这个延时是在锁中断里面，去除这个延时后在测试时间，时间缩小了近2000倍左右，此时在测试串口接收，接收数据正常，中断也没有丢失。


## 6.结论

因为在时统卡读接口（xpDmaRead）里有比较大的延时处理和加锁的处理，导致调用一次这个接口花费时间很长，此接口又用在中断服务函数里，一旦进时统中断就会导致其它设备的一些中断丢失，影响正常的功能。

## 7.建议

1. 将时统卡读接口（xpDmaRead）里获取传输状态的延时等待根据实际的硬件环境进行优化，804的龙芯3A3000硬件下直接屏蔽。
2. 将时统卡读接口（xpDmaRead）里需要保护的数据获取用锁保护起来，其余可以不用保护的放开锁进行处理。
