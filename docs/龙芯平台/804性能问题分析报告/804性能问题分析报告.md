# 804性能问题分析报告

## 1.时间

2023年4月27日

## 2.项目

804所龙芯XXX项目

## 3.应用场景

![1](C:\Users\Tidus\Desktop\804性能问题分析报告\图片1.png)

设备A将网络数据发送给道系统，道系统收到A发送过来的数据之后，在规定的发送周期内（62.5ms）将数据进行解析处理，并且发送给设备B，B设备中应用解析数据，并显示。

## 4.问题现象

当设备A发送的数据量增加到某个值时，设备B数据显示不全，经过软件方确认，显示不全的原因是在道系统下运行的应用在规定周期内（62.5ms）没有将数据处理完毕，造成数据处理时序错误，导致显示不完整。

设备B数据显示不全的原因是因为道系统发送过来的数据不正确，从软件负责人处了解到，在应用中，如果道系统收到网络数据后，在规定的时间周期内，没有把接收到的数据解析完毕的话，当下一个周期到来时，将会造成数据的混乱与丢失，随着发送周期的递增，错误也随之增加。

添加时间戳发现，在道系统中负责接收解析数据的任务在规定的周期内不能将数据发送给设备B（处理时间大于62.5ms），以至于下一个发送周期到来的时候，上一次数据还没有处理完毕，造成设备B接收数据缺失，显示不全。通过查看应用代码得知，应用中进行数据解析的主要操作是一些浮点运算，即浮点运算耗时较长。

在应用中可以发现，使用的浮点运算涉及到的数学库函数有sqrt,fabs,atan三种，并且应用中使用了大量的循环嵌套语句。因此耗时长的有两个因素，一是使用大量的循环语句，二是执行数学库函数执行时间长。

## 5.解决方案

### 5.1 优化方案

根据问题分析可以看出，性能优化的方案主要分为两个部分，第一，操作系统优化数学库函数，减少数学库函数执行所消耗的时间；第二，应用方面，减少循环语句所消耗的时间。

首先，操作系统层面。如果在应用中涉及到数学计算时，可以对一些数学库函数进行优化。一般在内核库中对于数学库函数提供了两种实现方法，一种C实现，一种汇编实现。数学库中的函数默认调用的是使用C实现的接口，想要提高计算的速度，提升性能，可以修改数学函数的调用，直接调用汇编实现的接口。

其次，应用方面。gcc提供了一些标准的优化方案，可以通过使用不同的编译参数来开启相关功能，对于一些使用循环嵌套比较多的情况下，可以使用gcc参数中的（-O2）选项来开启二级优化功能，使得在编译过程中，由gcc编译器自动优化应用，可以显著减少应用执行过程中所需时间。

### 5.2 优化后效果

下面从系统优化与应用优化来展开测试，测试结果为任务处理一次数据所需要的时间：

> 注：测试输出信息中，最后一列即为执行一次数据处理所需要的时间，单位：ms

#### 5.2.1 系统不加优化，应用也不加优化

![2](C:\Users\Tidus\Desktop\804性能问题分析报告\图片2.png)

#### 5.2.2 系统优化，应用不加优化

![3](C:\Users\Tidus\Desktop\804性能问题分析报告\图片3.png)

#### 5.2.3 系统不优化，应用优化（-O2）

![4](C:\Users\Tidus\Desktop\804性能问题分析报告\图片4.png)

#### 5.2.4 系统优化，应用优化（-O2）

![5](C:\Users\Tidus\Desktop\804性能问题分析报告\图片5.png)

## 6.结论

通过优化后的测试结果可以得到，在系统优化与应用双重优化的情况下，性能能够达到58ms左右，能满足指标（时间小于62.5ms），但是从通过软件负责人了解到，他们的需求是在满足指标的同时，应该还需要留有一定的余量（30%左右）。由此看来，目前还不能满足性能指标。

## 7.建议

因为此次使用的CPU型号为龙芯3A3000，因此关于内核部分数学库函数的优化方案是龙芯技术人员提供的。目前对于用到的三个数学库函数sqrt,fabs,atan，因为应用中需要使用双精度的浮点类型，而标准的MIPS数学库只提供了单精度的汇编实现接口，对于双精度的实现需要龙芯提供技术支持，此次龙芯只提供了sqrt,fabs的汇编实现，而对于atan的实现，龙芯技术人员评估修改可能会有风险，因此此次优化并未修改。修改atan应该还能提升一点性能，但是还是不足以满足指标需求。

所以，硬件方面，建议可以直接联系龙芯，咨询继续优化可行性。对于应用方面，看能否优化应用程序，减少循环使用次数。

